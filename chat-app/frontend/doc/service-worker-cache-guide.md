# Service Worker 缓存系统使用指南

## 概述

为了解决 Vite 开发环境中页面加载时间长的问题，我们实现了一套专门针对开发环境的 Service Worker 缓存系统。该系统可以缓存 API 响应，显著减少重复的网络请求，提高开发效率。

## 系统组成

### 1. 核心文件

- **`public/sw-dev.js`**: 开发环境专用的 Service Worker 脚本
- **`src/lib/swManager.js`**: Service Worker 管理器
- **`src/components/CacheStatusIndicator.jsx`**: 缓存状态指示器
- **`src/components/CacheControlPanel.jsx`**: 缓存控制面板

### 2. 主要功能

#### 智能缓存策略
- 自动缓存 GET 类型的 API 请求
- 可配置的缓存时长（默认 5 分钟）
- 智能跳过实时性要求高的接口（如登录、发送消息等）
- 网络失败时自动使用缓存数据

#### 实时监控
- 缓存命中率统计
- 实时事件日志
- 网络状态监控
- 缓存条目管理

#### 灵活控制
- 一键清理所有缓存
- 按模式清理特定缓存
- 动态调整缓存时长
- 可视化缓存状态

## 使用方法

### 1. 启动开发服务器

```bash
npm run dev
```

Service Worker 会在开发环境自动注册并开始工作。

### 2. 查看缓存状态

在页面右下角会显示缓存状态指示器，包含：
- 当前网络状态
- 缓存命中数/未命中数/命中率
- 最近的缓存活动

### 3. 使用控制面板

点击状态指示器上的设置按钮或"打开控制面板"按钮，可以：

#### 查看缓存统计
- 缓存条目总数
- 当前缓存时长设置
- 实时事件计数

#### 管理缓存
- **刷新信息**: 获取最新的缓存状态
- **清理所有缓存**: 清空所有 API 缓存
- **清理消息缓存**: 只清理消息相关的缓存
- **清理用户缓存**: 只清理用户相关的缓存

#### 调整设置
- 修改缓存持续时间（10秒 - 3600秒）
- 应用新的缓存设置

#### 监控活动
- 查看所有缓存条目及其状态
- 实时查看缓存事件日志
- 区分有效缓存和过期缓存

## 缓存规则

### 自动缓存的接口
- `/api/auth/check` - 用户认证检查
- `/api/users/*` - 用户相关接口
- `/api/messages/*` - 消息查询接口（不包括发送）
- `/api/profile/*` - 用户资料接口

### 不缓存的接口
- `/api/auth/login` - 用户登录
- `/api/auth/logout` - 用户登出
- `/api/auth/signup` - 用户注册
- `/api/messages/send` - 发送消息
- `/api/socket/*` - WebSocket 相关

### 缓存生效条件
- 仅在开发环境启用
- 只缓存 GET 请求
- 只缓存成功的响应（HTTP 200）
- 缓存会在设定时间后自动过期

## 开发建议

### 1. 合理设置缓存时间
- **短期接口**（用户状态、消息列表）: 1-2 分钟
- **中期接口**（用户列表、设置信息）: 5-10 分钟
- **长期接口**（配置信息、静态数据）: 30-60 分钟

### 2. 缓存清理时机
- **修改后端 API** 后清理相关缓存
- **调试特定功能** 时清理对应缓存
- **发现数据不一致** 时清理所有缓存

### 3. 性能监控
- 关注缓存命中率，理想值应在 60% 以上
- 观察实时事件，了解缓存工作情况
- 根据使用模式调整缓存策略

## 故障排除

### 1. Service Worker 未生效
- 检查浏览器控制台是否有错误信息
- 确认是否在开发环境（`npm run dev`）
- 刷新页面或重新启动开发服务器

### 2. 缓存未命中
- 检查接口是否在缓存规则内
- 确认请求方法为 GET
- 查看控制面板中的事件日志

### 3. 数据不一致
- 手动清理相关缓存
- 检查缓存时间设置是否合理
- 确认后端接口返回正确的数据

### 4. 性能问题
- 适当减少缓存时间
- 清理不必要的缓存条目
- 检查网络状态

## 注意事项

1. **仅开发环境启用**: 生产环境不会加载此缓存系统
2. **数据一致性**: 缓存可能导致数据延迟，需要根据业务需求调整
3. **内存使用**: 大量缓存会占用浏览器内存，定期清理有助于性能
4. **调试影响**: 某些调试场景可能需要禁用缓存

## 扩展配置

如需修改缓存策略，可以编辑 `public/sw-dev.js` 文件中的配置：

```javascript
// 修改缓存时长
const CACHE_DURATION = 10 * 60 * 1000; // 10分钟

// 添加新的缓存接口
const API_PATTERNS = [
  /\/api\/auth\/check/,
  /\/api\/users/,
  /\/api\/messages/,
  /\/api\/profile/,
  /\/api\/your-new-endpoint/,  // 新增
];

// 添加不缓存的接口
const NO_CACHE_PATTERNS = [
  /\/api\/auth\/login/,
  /\/api\/auth\/logout/,
  /\/api\/your-realtime-endpoint/,  // 新增
];
```

修改后需要刷新页面使配置生效。





