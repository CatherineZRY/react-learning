<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
  <title>CustomEvent vs BroadcastChannel é€šä¿¡æ–¹å¼å¯¹æ¯”</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .method-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .custom-event-section {
      border-left: 4px solid #007bff;
    }

    .broadcast-channel-section {
      border-left: 4px solid #28a745;
    }

    .demo-area {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }

    .btn.broadcast {
      background: #28a745;
    }

    .btn:hover {
      opacity: 0.8;
    }

    .message-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
    }

    .message-display {
      background: #e9ecef;
      padding: 10px;
      border-radius: 4px;
      min-height: 100px;
      margin: 10px 0;
      overflow-y: auto;
      max-height: 200px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .comparison-table th,
    .comparison-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    .comparison-table th {
      background: #f8f9fa;
      font-weight: bold;
    }

    .pros {
      color: #28a745;
      font-weight: bold;
    }

    .cons {
      color: #dc3545;
      font-weight: bold;
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      overflow-x: auto;
    }

    .highlight {
      background: #fff3cd;
      padding: 15px;
      border-left: 4px solid #ffc107;
      margin: 10px 0;
    }

    .tab-new-info {
      background: #d1ecf1;
      padding: 15px;
      border-left: 4px solid #17a2b8;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”„ CustomEvent vs BroadcastChannel é€šä¿¡æ–¹å¼å¯¹æ¯”</h1>

    <!-- æ ¸å¿ƒå·®å¼‚æ¦‚è¿° -->
    <div class="method-section">
      <h2>ğŸ“‹ æ ¸å¿ƒå·®å¼‚æ¦‚è¿°</h2>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>ç‰¹æ€§</th>
            <th>CustomEvent</th>
            <th>BroadcastChannel</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>ä½œç”¨åŸŸ</strong></td>
            <td>åŒä¸€é¡µé¢å†…çš„ä¸åŒç»„ä»¶</td>
            <td>åŒæºçš„ä¸åŒé¡µé¢/æ ‡ç­¾é¡µ/Worker</td>
          </tr>
          <tr>
            <td><strong>é€šä¿¡èŒƒå›´</strong></td>
            <td>å½“å‰ window å¯¹è±¡</td>
            <td>åŒæºçš„æ‰€æœ‰æµè§ˆä¸Šä¸‹æ–‡</td>
          </tr>
          <tr>
            <td><strong>è·¨æ ‡ç­¾é¡µ</strong></td>
            <td>âŒ ä¸æ”¯æŒ</td>
            <td>âœ… æ”¯æŒ</td>
          </tr>
          <tr>
            <td><strong>Worker æ”¯æŒ</strong></td>
            <td>âŒ ä¸æ”¯æŒ</td>
            <td>âœ… æ”¯æŒ</td>
          </tr>
          <tr>
            <td><strong>æµè§ˆå™¨å…¼å®¹æ€§</strong></td>
            <td>âœ… ä¼˜ç§€ï¼ˆIE9+ï¼‰</td>
            <td>âš ï¸ è¾ƒæ–°ï¼ˆChrome 54+ï¼‰</td>
          </tr>
          <tr>
            <td><strong>æ€§èƒ½</strong></td>
            <td>âœ… æ›´å¿«ï¼ˆåŒæ­¥ï¼‰</td>
            <td>âš ï¸ ç¨æ…¢ï¼ˆå¼‚æ­¥ï¼‰</td>
          </tr>
          <tr>
            <td><strong>API å¤æ‚åº¦</strong></td>
            <td>ç®€å•</td>
            <td>éå¸¸ç®€å•</td>
          </tr>
          <tr>
            <td><strong>å‘é€è€…æ¥æ”¶</strong></td>
            <td>âœ… å‘é€è€…å¯ä»¥æ”¶åˆ°è‡ªå·±çš„æ¶ˆæ¯</td>
            <td>âŒ å‘é€è€…ä¸ä¼šæ”¶åˆ°è‡ªå·±çš„æ¶ˆæ¯</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- å®é™…æ¼”ç¤ºå¯¹æ¯” -->
    <div class="comparison-grid">
      <!-- CustomEvent æ¼”ç¤º -->
      <div class="method-section custom-event-section">
        <h2>ğŸ¯ CustomEvent æ¼”ç¤º</h2>
        <p><strong>é€‚ç”¨äºï¼š</strong>åŒä¸€é¡µé¢å†…çš„å¾®å‰ç«¯åº”ç”¨é—´é€šä¿¡</p>

        <div class="demo-area">
          <h4>å‘é€ CustomEvent æ¶ˆæ¯ï¼š</h4>
          <input type="text"
            id="customEventInput"
            class="message-input"
            placeholder="è¾“å…¥ CustomEvent æ¶ˆæ¯">
          <div>
            <button class="btn"
              onclick="sendCustomEvent()">å‘é€äº‹ä»¶</button>
            <button class="btn"
              onclick="sendCustomEventWithData()">å‘é€å¸¦æ•°æ®çš„äº‹ä»¶</button>
          </div>
        </div>

        <div class="demo-area">
          <h4>CustomEvent æ¥æ”¶åŒºï¼š</h4>
          <div id="customEventMessages"
            class="message-display">
            ç­‰å¾…æ¥æ”¶ CustomEvent æ¶ˆæ¯...
          </div>
          <button class="btn"
            onclick="clearCustomEventMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
        </div>

        <div class="code-block">
          <pre>// CustomEvent å‘é€
const event = new CustomEvent('my-event', {
    detail: { message: 'Hello' }
});
window.dispatchEvent(event);

// CustomEvent æ¥æ”¶
window.addEventListener('my-event', (event) => {
    console.log('æ”¶åˆ°:', event.detail);
});</pre>
        </div>
      </div>

      <!-- BroadcastChannel æ¼”ç¤º -->
      <div class="method-section broadcast-channel-section">
        <h2>ğŸ“¡ BroadcastChannel æ¼”ç¤º</h2>
        <p><strong>é€‚ç”¨äºï¼š</strong>è·¨æ ‡ç­¾é¡µ/Worker çš„åº”ç”¨é—´é€šä¿¡</p>

        <div class="demo-area">
          <h4>å‘é€ BroadcastChannel æ¶ˆæ¯ï¼š</h4>
          <input type="text"
            id="broadcastChannelInput"
            class="message-input"
            placeholder="è¾“å…¥ BroadcastChannel æ¶ˆæ¯">
          <div>
            <button class="btn broadcast"
              onclick="sendBroadcastMessage()">å‘é€æ¶ˆæ¯</button>
            <button class="btn broadcast"
              onclick="sendBroadcastWithData()">å‘é€å¸¦æ•°æ®çš„æ¶ˆæ¯</button>
          </div>
        </div>

        <div class="demo-area">
          <h4>BroadcastChannel æ¥æ”¶åŒºï¼š</h4>
          <div id="broadcastChannelMessages"
            class="message-display">
            ç­‰å¾…æ¥æ”¶ BroadcastChannel æ¶ˆæ¯...
          </div>
          <button class="btn broadcast"
            onclick="clearBroadcastMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
        </div>

        <div class="tab-new-info">
          <strong>ğŸ’¡ è·¨æ ‡ç­¾é¡µæµ‹è¯•ï¼š</strong>
          <br>æ‰“å¼€ä¸€ä¸ªæ–°æ ‡ç­¾é¡µè®¿é—®ç›¸åŒé¡µé¢ï¼Œåœ¨ä»»ä¸€æ ‡ç­¾é¡µå‘é€ BroadcastChannel æ¶ˆæ¯ï¼Œ
          å…¶ä»–æ ‡ç­¾é¡µä¹Ÿä¼šæ”¶åˆ°æ¶ˆæ¯ï¼
          <br>
          <button class="btn broadcast"
            onclick="openNewTab()">æ‰“å¼€æ–°æ ‡ç­¾é¡µæµ‹è¯•</button>
        </div>

        <div class="highlight">
          <strong>âš ï¸ é‡è¦ç‰¹æ€§ï¼š</strong>
          <br><strong>BroadcastChannel ä¸ä¼šå°†æ¶ˆæ¯å‘é€ç»™å‘é€è€…è‡ªå·±ï¼</strong>
          <br>è¿™æ˜¯ API çš„è®¾è®¡ç‰¹æ€§ï¼Œç”¨äºé¿å…æ— é™å¾ªç¯å’Œæ˜ç¡®è·¨ä¸Šä¸‹æ–‡é€šä¿¡çš„ç›®çš„ã€‚
          <br>å¦‚æœä½ åœ¨å½“å‰æ ‡ç­¾é¡µå‘é€æ¶ˆæ¯ï¼Œå½“å‰æ ‡ç­¾é¡µä¸ä¼šæ”¶åˆ°ï¼Œä½†å…¶ä»–æ ‡ç­¾é¡µä¼šæ”¶åˆ°ã€‚
        </div>

        <div class="code-block">
          <pre>// BroadcastChannel åˆ›å»º
const channel = new BroadcastChannel('my-channel');

// å‘é€æ¶ˆæ¯
channel.postMessage({ message: 'Hello' });

// æ¥æ”¶æ¶ˆæ¯
channel.onmessage = (event) => {
    console.log('æ”¶åˆ°:', event.data);
};</pre>
        </div>
      </div>
    </div>

    <!-- å¾®å‰ç«¯åœºæ™¯åˆ†æ -->
    <div class="method-section">
      <h2>ğŸ—ï¸ å¾®å‰ç«¯åº”ç”¨åœºæ™¯åˆ†æ</h2>

      <h3>1. Single-SPA å¾®å‰ç«¯ä¸­çš„é€‰æ‹©</h3>
      <div class="highlight">
        <h4>æ¨èä½¿ç”¨ CustomEvent çš„æƒ…å†µï¼š</h4>
        <ul>
          <li>âœ… åŒä¸€é¡µé¢å†…çš„å¾®åº”ç”¨é—´é€šä¿¡ï¼ˆSingle-SPA çš„å…¸å‹åœºæ™¯ï¼‰</li>
          <li>âœ… éœ€è¦é«˜æ€§èƒ½çš„å®æ—¶é€šä¿¡</li>
          <li>âœ… éœ€è¦æ”¯æŒè€ç‰ˆæœ¬æµè§ˆå™¨</li>
          <li>âœ… ç®€å•çš„äº‹ä»¶é©±åŠ¨é€šä¿¡</li>
        </ul>
      </div>

      <div class="highlight">
        <h4>æ¨èä½¿ç”¨ BroadcastChannel çš„æƒ…å†µï¼š</h4>
        <ul>
          <li>âœ… éœ€è¦è·¨æ ‡ç­¾é¡µåŒæ­¥çŠ¶æ€ï¼ˆå¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼‰</li>
          <li>âœ… å¤šæ ‡ç­¾é¡µçš„åº”ç”¨éœ€è¦æ•°æ®åŒæ­¥</li>
          <li>âœ… éœ€è¦ä¸ Web Worker é€šä¿¡</li>
          <li>âœ… æ„å»ºå¤šçª—å£åº”ç”¨</li>
        </ul>
      </div>

      <h3>2. å®é™…åº”ç”¨ç¤ºä¾‹</h3>
      <div class="code-block">
        <pre>// å¾®å‰ç«¯ä¸­çš„ CustomEvent ä½¿ç”¨
class MicroAppCommunication {
    constructor() {
        this.setupCustomEventListeners();
    }
    
    // å‘é€ç”¨æˆ·ç™»å½•äº‹ä»¶
    notifyUserLogin(user) {
        window.dispatchEvent(new CustomEvent('user-login', {
            detail: { user, timestamp: Date.now() }
        }));
    }
    
    // ç›‘å¬ç”¨æˆ·ç™»å½•äº‹ä»¶
    setupCustomEventListeners() {
        window.addEventListener('user-login', (event) => {
            console.log('ç”¨æˆ·å·²ç™»å½•:', event.detail.user);
            this.updateUI(event.detail.user);
        });
    }
}

// è·¨æ ‡ç­¾é¡µçš„ BroadcastChannel ä½¿ç”¨
class CrossTabCommunication {
    constructor() {
        this.channel = new BroadcastChannel('app-sync');
        this.setupBroadcastListeners();
    }
    
    // åŒæ­¥ç”¨æˆ·ç™»å½•çŠ¶æ€åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
    syncUserLogin(user) {
        this.channel.postMessage({
            type: 'USER_LOGIN',
            data: user,
            timestamp: Date.now()
        });
    }
    
    // ç›‘å¬å…¶ä»–æ ‡ç­¾é¡µçš„æ¶ˆæ¯
    setupBroadcastListeners() {
        this.channel.onmessage = (event) => {
            const { type, data } = event.data;
            if (type === 'USER_LOGIN') {
                this.handleUserLogin(data);
            }
        };
    }
}

// è¡Œä¸ºå·®å¼‚å¯¹æ¯”æ¼”ç¤º
console.log('=== CustomEvent æµ‹è¯• ===');
window.addEventListener('test-custom', (e) => {
    console.log('CustomEvent æ”¶åˆ°æ¶ˆæ¯:', e.detail.message);
    // âœ… ä¼šæ‰§è¡Œï¼šå‘é€è€…å¯ä»¥æ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯
});

window.dispatchEvent(new CustomEvent('test-custom', {
    detail: { message: 'è‡ªå·±å‘é€çš„æ¶ˆæ¯' }
}));

console.log('=== BroadcastChannel æµ‹è¯• ===');
const channel = new BroadcastChannel('test-channel');
channel.onmessage = (e) => {
    console.log('BroadcastChannel æ”¶åˆ°æ¶ˆæ¯:', e.data.message);
    // âŒ ä¸ä¼šæ‰§è¡Œï¼šå‘é€è€…ä¸ä¼šæ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯
};

channel.postMessage({ message: 'è‡ªå·±å‘é€çš„æ¶ˆæ¯' });</pre>
      </div>

      <h3>3. è¡Œä¸ºå·®å¼‚å¯¹æ¯”æ¼”ç¤º</h3>
      <div class="demo-area">
        <h4>æµ‹è¯•æ¶ˆæ¯å‘é€è¡Œä¸ºï¼š</h4>
        <input type="text"
          id="behaviorTestInput"
          class="message-input"
          placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn"
            onclick="testCustomEventBehavior()">
            æµ‹è¯• CustomEventï¼ˆä¼šæ”¶åˆ°è‡ªå·±çš„æ¶ˆæ¯ï¼‰
          </button>
          <button class="btn broadcast"
            onclick="testBroadcastBehavior()">
            æµ‹è¯• BroadcastChannelï¼ˆä¸ä¼šæ”¶åˆ°è‡ªå·±çš„æ¶ˆæ¯ï¼‰
          </button>
        </div>
        <div id="behaviorTestResults"
          class="message-display"
          style="margin-top: 10px;">
          ç‚¹å‡»æŒ‰é’®æµ‹è¯•ä¸¤ç§é€šä¿¡æ–¹å¼çš„è¡Œä¸ºå·®å¼‚...
        </div>
      </div>

      <div class="code-block">
        <pre>// è¡Œä¸ºå·®å¼‚ç¤ºä¾‹
console.log('=== CustomEvent æµ‹è¯• ===');
window.addEventListener('test-custom', (e) => {
    console.log('CustomEvent æ”¶åˆ°æ¶ˆæ¯:', e.detail.message);
    // âœ… ä¼šæ‰§è¡Œï¼šå‘é€è€…å¯ä»¥æ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯
});

window.dispatchEvent(new CustomEvent('test-custom', {
    detail: { message: 'è‡ªå·±å‘é€çš„æ¶ˆæ¯' }
}));

console.log('=== BroadcastChannel æµ‹è¯• ===');
const channel = new BroadcastChannel('test-channel');
channel.onmessage = (e) => {
    console.log('BroadcastChannel æ”¶åˆ°æ¶ˆæ¯:', e.data.message);
    // âŒ ä¸ä¼šæ‰§è¡Œï¼šå‘é€è€…ä¸ä¼šæ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯
};

channel.postMessage({ message: 'è‡ªå·±å‘é€çš„æ¶ˆæ¯' });</pre>
      </div>
    </div>

    <!-- æ€§èƒ½å’Œå…¼å®¹æ€§å¯¹æ¯” -->
    <div class="method-section">
      <h2>âš¡ æ€§èƒ½å’Œå…¼å®¹æ€§å¯¹æ¯”</h2>

      <h3>æ€§èƒ½æµ‹è¯•</h3>
      <div class="demo-area">
        <button class="btn"
          onclick="performanceTest()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
        <div id="performanceResults"
          class="message-display">
          ç‚¹å‡»æŒ‰é’®å¼€å§‹æ€§èƒ½æµ‹è¯•...
        </div>
      </div>

      <h3>æµè§ˆå™¨å…¼å®¹æ€§</h3>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>æµè§ˆå™¨</th>
            <th>CustomEvent</th>
            <th>BroadcastChannel</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Chrome</td>
            <td class="pros">âœ… 15+</td>
            <td class="pros">âœ… 54+</td>
          </tr>
          <tr>
            <td>Firefox</td>
            <td class="pros">âœ… 11+</td>
            <td class="pros">âœ… 38+</td>
          </tr>
          <tr>
            <td>Safari</td>
            <td class="pros">âœ… 6+</td>
            <td class="pros">âœ… 15.4+</td>
          </tr>
          <tr>
            <td>Edge</td>
            <td class="pros">âœ… 12+</td>
            <td class="pros">âœ… 79+</td>
          </tr>
          <tr>
            <td>IE</td>
            <td class="pros">âœ… 9+</td>
            <td class="cons">âŒ ä¸æ”¯æŒ</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- æœ€ä½³å®è·µå»ºè®® -->
    <div class="method-section">
      <h2>ğŸ’¡ æœ€ä½³å®è·µå»ºè®®</h2>

      <h3>1. é€‰æ‹©å†³ç­–æ ‘</h3>
      <div class="code-block">
        <pre>é€‰æ‹©é€šä¿¡æ–¹å¼çš„å†³ç­–æµç¨‹ï¼š

1. æ˜¯å¦éœ€è¦è·¨æ ‡ç­¾é¡µé€šä¿¡ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ BroadcastChannel
   â””â”€ å¦ â†’ ç»§ç»­ä¸‹ä¸€æ­¥

2. æ˜¯å¦éœ€è¦æ”¯æŒ IE æµè§ˆå™¨ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ CustomEvent
   â””â”€ å¦ â†’ ç»§ç»­ä¸‹ä¸€æ­¥

3. æ˜¯å¦éœ€è¦ä¸ Web Worker é€šä¿¡ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ BroadcastChannel
   â””â”€ å¦ â†’ ä½¿ç”¨ CustomEventï¼ˆæ¨èï¼‰

4. å¾®å‰ç«¯ Single-SPA åœºæ™¯ï¼š
   â””â”€ æ¨èä½¿ç”¨ CustomEvent</pre>
      </div>

      <h3>2. æ··åˆä½¿ç”¨ç­–ç•¥</h3>
      <div class="highlight">
        <p><strong>åœ¨å¤æ‚åº”ç”¨ä¸­ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼ï¼š</strong></p>
        <ul>
          <li><strong>CustomEvent</strong>ï¼šå¤„ç†é¡µé¢å†…å¾®åº”ç”¨é—´çš„å®æ—¶é€šä¿¡</li>
          <li><strong>BroadcastChannel</strong>ï¼šå¤„ç†è·¨æ ‡ç­¾é¡µçš„çŠ¶æ€åŒæ­¥</li>
        </ul>
      </div>

      <div class="code-block">
        <pre>// æ··åˆä½¿ç”¨ç¤ºä¾‹
class HybridCommunication {
    constructor() {
        // é¡µé¢å†…é€šä¿¡
        this.setupCustomEvents();
        
        // è·¨æ ‡ç­¾é¡µé€šä¿¡
        if ('BroadcastChannel' in window) {
            this.setupBroadcastChannel();
        }
    }
    
    // å‘é€æ¶ˆæ¯ï¼ˆæ™ºèƒ½é€‰æ‹©é€šä¿¡æ–¹å¼ï¼‰
    sendMessage(type, data, crossTab = false) {
        if (crossTab && this.broadcastChannel) {
            // è·¨æ ‡ç­¾é¡µæ¶ˆæ¯
            this.broadcastChannel.postMessage({ type, data });
        } else {
            // é¡µé¢å†…æ¶ˆæ¯
            window.dispatchEvent(new CustomEvent(type, { detail: data }));
        }
    }
}</pre>
      </div>
    </div>
  </div>

  <script>
    // CustomEvent ç›¸å…³åŠŸèƒ½
    let customEventCount = 0;

    function sendCustomEvent() {
      const message = document.getElementById('customEventInput').value || 'CustomEvent æµ‹è¯•æ¶ˆæ¯';
      const event = new CustomEvent('micro-app-custom', {
        detail: {
          message: message,
          timestamp: new Date().toISOString(),
          id: ++customEventCount
        }
      });
      window.dispatchEvent(event);
      document.getElementById('customEventInput').value = '';
    }

    function sendCustomEventWithData() {
      const message = document.getElementById('customEventInput').value || 'CustomEvent æ•°æ®æ¶ˆæ¯';
      const event = new CustomEvent('micro-app-custom-data', {
        detail: {
          message: message,
          data: {
            user: 'User123',
            action: 'test',
            payload: { count: customEventCount }
          },
          timestamp: new Date().toISOString(),
          id: ++customEventCount
        }
      });
      window.dispatchEvent(event);
      document.getElementById('customEventInput').value = '';
    }

    function clearCustomEventMessages() {
      document.getElementById('customEventMessages').innerHTML = 'ç­‰å¾…æ¥æ”¶ CustomEvent æ¶ˆæ¯...';
    }

    // BroadcastChannel ç›¸å…³åŠŸèƒ½
    let broadcastChannel;
    let broadcastCount = 0;

    if ('BroadcastChannel' in window) {
      broadcastChannel = new BroadcastChannel('micro-app-demo');

      broadcastChannel.onmessage = function (event) {
        const messagesDiv = document.getElementById('broadcastChannelMessages');
        const { message, timestamp, id, data } = event.data;
        const messageHtml = `
                    <div style="border-bottom: 1px solid #ddd; padding: 5px 0;">
                        <strong>[${new Date(timestamp).toLocaleTimeString()}] #${id}</strong><br>
                        ğŸ“¡ ${message}
                        ${data ? `<br><small>æ•°æ®: ${JSON.stringify(data)}</small>` : ''}
                    </div>
                `;
        messagesDiv.innerHTML = messageHtml + messagesDiv.innerHTML;
      };
    }

    function sendBroadcastMessage() {
      if (!broadcastChannel) {
        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ BroadcastChannel');
        return;
      }

      const message = document.getElementById('broadcastChannelInput').value || 'BroadcastChannel æµ‹è¯•æ¶ˆæ¯';
      broadcastChannel.postMessage({
        message: message,
        timestamp: new Date().toISOString(),
        id: ++broadcastCount
      });
      document.getElementById('broadcastChannelInput').value = '';
    }

    function sendBroadcastWithData() {
      if (!broadcastChannel) {
        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ BroadcastChannel');
        return;
      }

      const message = document.getElementById('broadcastChannelInput').value || 'BroadcastChannel æ•°æ®æ¶ˆæ¯';
      broadcastChannel.postMessage({
        message: message,
        data: {
          user: 'User456',
          action: 'broadcast_test',
          payload: { count: broadcastCount }
        },
        timestamp: new Date().toISOString(),
        id: ++broadcastCount
      });
      document.getElementById('broadcastChannelInput').value = '';
    }

    function clearBroadcastMessages() {
      document.getElementById('broadcastChannelMessages').innerHTML = 'ç­‰å¾…æ¥æ”¶ BroadcastChannel æ¶ˆæ¯...';
    }

    function openNewTab() {
      window.open(window.location.href, '_blank');
    }

    // CustomEvent ç›‘å¬å™¨
    window.addEventListener('micro-app-custom', function (event) {
      const messagesDiv = document.getElementById('customEventMessages');
      const { message, timestamp, id } = event.detail;
      const messageHtml = `
                <div style="border-bottom: 1px solid #ddd; padding: 5px 0;">
                    <strong>[${new Date(timestamp).toLocaleTimeString()}] #${id}</strong><br>
                    ğŸ¯ ${message}
                </div>
            `;
      messagesDiv.innerHTML = messageHtml + messagesDiv.innerHTML;
    });

    window.addEventListener('micro-app-custom-data', function (event) {
      const messagesDiv = document.getElementById('customEventMessages');
      const { message, timestamp, id, data } = event.detail;
      const messageHtml = `
                <div style="border-bottom: 1px solid #ddd; padding: 5px 0;">
                    <strong>[${new Date(timestamp).toLocaleTimeString()}] #${id}</strong><br>
                    ğŸ¯ ${message}<br>
                    <small>æ•°æ®: ${JSON.stringify(data)}</small>
                </div>
            `;
      messagesDiv.innerHTML = messageHtml + messagesDiv.innerHTML;
    });

    // æ€§èƒ½æµ‹è¯•
    function performanceTest() {
      const resultsDiv = document.getElementById('performanceResults');
      resultsDiv.innerHTML = 'æ­£åœ¨è¿è¡Œæ€§èƒ½æµ‹è¯•...';

      const testCount = 10000;

      // CustomEvent æ€§èƒ½æµ‹è¯•
      const customEventStart = performance.now();
      for (let i = 0; i < testCount; i++) {
        const event = new CustomEvent('perf-test', { detail: { index: i } });
        window.dispatchEvent(event);
      }
      const customEventEnd = performance.now();
      const customEventTime = customEventEnd - customEventStart;

      // BroadcastChannel æ€§èƒ½æµ‹è¯•
      let broadcastTime = 'N/A (ä¸æ”¯æŒ)';
      if (broadcastChannel) {
        const broadcastStart = performance.now();
        for (let i = 0; i < testCount; i++) {
          broadcastChannel.postMessage({ index: i });
        }
        const broadcastEnd = performance.now();
        broadcastTime = (broadcastEnd - broadcastStart).toFixed(2) + ' ms';
      }

      resultsDiv.innerHTML = `
                <strong>æ€§èƒ½æµ‹è¯•ç»“æœ (${testCount} æ¬¡æ“ä½œ):</strong><br>
                CustomEvent: ${customEventTime.toFixed(2)} ms<br>
                BroadcastChannel: ${broadcastTime}<br>
                <br>
                <small>æ³¨æ„ï¼šBroadcastChannel æ˜¯å¼‚æ­¥çš„ï¼Œå®é™…å»¶è¿Ÿå¯èƒ½æ›´é«˜</small>
            `;
    }

    // æ€§èƒ½æµ‹è¯•ç›‘å¬å™¨
    let perfTestCount = 0;
    window.addEventListener('perf-test', function (event) {
      perfTestCount++;
    });

    // åˆå§‹åŒ–æç¤º
    document.addEventListener('DOMContentLoaded', function () {
      if (!('BroadcastChannel' in window)) {
        document.getElementById('broadcastChannelMessages').innerHTML =
          '<span style="color: red;">âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ BroadcastChannel API</span>';
      }
    });

    // è¡Œä¸ºå·®å¼‚æµ‹è¯•å‡½æ•°
    function testCustomEventBehavior() {
      const message = document.getElementById('behaviorTestInput').value || 'CustomEvent è¡Œä¸ºæµ‹è¯•';
      const resultsDiv = document.getElementById('behaviorTestResults');

      // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
      resultsDiv.innerHTML = 'æ­£åœ¨æµ‹è¯• CustomEvent è¡Œä¸º...<br>';

      // è®¾ç½®ç›‘å¬å™¨
      const listener = function (event) {
        resultsDiv.innerHTML += `âœ… CustomEvent æ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯: "${event.detail.message}"<br>`;
        resultsDiv.innerHTML += `<small>æ—¶é—´: ${new Date().toLocaleTimeString()}</small><br>`;
        // ç§»é™¤ç›‘å¬å™¨é¿å…é‡å¤
        window.removeEventListener('behavior-test-custom', listener);
      };

      window.addEventListener('behavior-test-custom', listener);

      // å‘é€æ¶ˆæ¯
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('behavior-test-custom', {
          detail: { message: message }
        }));
      }, 100);
    }

    function testBroadcastBehavior() {
      const message = document.getElementById('behaviorTestInput').value || 'BroadcastChannel è¡Œä¸ºæµ‹è¯•';
      const resultsDiv = document.getElementById('behaviorTestResults');

      if (!broadcastChannel) {
        resultsDiv.innerHTML = 'âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ BroadcastChannel';
        return;
      }

      // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
      resultsDiv.innerHTML = 'æ­£åœ¨æµ‹è¯• BroadcastChannel è¡Œä¸º...<br>';

      // åˆ›å»ºä¸“é—¨çš„æµ‹è¯•é¢‘é“
      const testChannel = new BroadcastChannel('behavior-test');

      // è®¾ç½®ç›‘å¬å™¨
      testChannel.onmessage = function (event) {
        resultsDiv.innerHTML += `âœ… BroadcastChannel æ”¶åˆ°æ¶ˆæ¯: "${event.data.message}"<br>`;
        resultsDiv.innerHTML += `<small>æ—¶é—´: ${new Date().toLocaleTimeString()}</small><br>`;
        testChannel.close();
      };

      // å‘é€æ¶ˆæ¯
      setTimeout(() => {
        testChannel.postMessage({ message: message });

        // ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œæ˜¾ç¤ºè¯´æ˜
        setTimeout(() => {
          if (resultsDiv.innerHTML.indexOf('BroadcastChannel æ”¶åˆ°æ¶ˆæ¯') === -1) {
            resultsDiv.innerHTML += `âŒ BroadcastChannel æ²¡æœ‰æ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯: "${message}"<br>`;
            resultsDiv.innerHTML += `<small>è¿™æ˜¯æ­£å¸¸è¡Œä¸ºï¼šBroadcastChannel ä¸ä¼šå‘é€æ¶ˆæ¯ç»™å‘é€è€…è‡ªå·±</small><br>`;
            resultsDiv.innerHTML += `<small>ğŸ’¡ è¯·æ‰“å¼€æ–°æ ‡ç­¾é¡µæµ‹è¯•è·¨æ ‡ç­¾é¡µé€šä¿¡</small><br>`;
          }
          testChannel.close();
        }, 500);
      }, 100);
    }
  </script>
</body>

</html>