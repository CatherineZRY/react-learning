<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
  <title>CustomEvent åŒé¡µé¢é€šä¿¡æ¼”ç¤º</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .demo-section {
      background: white;
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .component-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .component {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .component.sender {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .component.receiver {
      border-color: #28a745;
      background: #e8f5e8;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    .btn:hover {
      background: #0056b3;
    }

    .message-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
    }

    .message-log {
      background: #000;
      color: #00ff00;
      padding: 15px;
      border-radius: 4px;
      height: 150px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin: 10px 0;
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      overflow-x: auto;
    }

    .highlight {
      background: #fff3cd;
      padding: 15px;
      border-left: 4px solid #ffc107;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ¯ CustomEvent åŒé¡µé¢é€šä¿¡æ¼”ç¤º</h1>

    <div class="demo-section">
      <div class="highlight">
        <h3>ğŸ” å…³é”®ç‰¹æ€§éªŒè¯ï¼š</h3>
        <p><strong>CustomEvent å‘é€çš„æ¶ˆæ¯ï¼ŒåŒä¸€ä¸ªé¡µé¢å†…çš„æ‰€æœ‰ç›‘å¬å™¨éƒ½èƒ½æ¥æ”¶åˆ°ï¼ŒåŒ…æ‹¬å‘é€è€…è‡ªå·±ï¼</strong></p>
        <ul>
          <li>âœ… å‘é€è€…å¯ä»¥æ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯</li>
          <li>âœ… åŒä¸€é¡µé¢å†…çš„å…¶ä»–ç»„ä»¶ä¹Ÿèƒ½æ”¶åˆ°æ¶ˆæ¯</li>
          <li>âœ… æ¶ˆæ¯ä¼ é€’æ˜¯åŒæ­¥çš„ï¼Œç«‹å³æ‰§è¡Œ</li>
        </ul>
      </div>
    </div>

    <!-- ç»„ä»¶æ¼”ç¤ºåŒºåŸŸ -->
    <div class="component-grid">
      <!-- å‘é€è€…ç»„ä»¶ -->
      <div class="component sender">
        <h3>ğŸ“¤ å‘é€è€…ç»„ä»¶</h3>
        <p>æ¨¡æ‹Ÿå¾®å‰ç«¯ä¸­çš„ä¸€ä¸ªåº”ç”¨</p>
        <input type="text"
          id="senderInput"
          class="message-input"
          placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯">
        <div>
          <button class="btn"
            onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
          <button class="btn"
            onclick="sendUserLogin()">å‘é€ç”¨æˆ·ç™»å½•äº‹ä»¶</button>
          <button class="btn"
            onclick="sendDataUpdate()">å‘é€æ•°æ®æ›´æ–°äº‹ä»¶</button>
        </div>
        <div id="senderLog"
          class="message-log">å‘é€è€…æ—¥å¿—åŒºåŸŸ...</div>
      </div>

      <!-- æ¥æ”¶è€…ç»„ä»¶ 1 -->
      <div class="component receiver">
        <h3>ğŸ“¥ æ¥æ”¶è€…ç»„ä»¶ A</h3>
        <p>æ¨¡æ‹Ÿå¾®å‰ç«¯ä¸­çš„å¦ä¸€ä¸ªåº”ç”¨</p>
        <div id="receiverALog"
          class="message-log">æ¥æ”¶è€…Aæ—¥å¿—åŒºåŸŸ...</div>
        <button class="btn"
          onclick="clearReceiverALog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>

      <!-- æ¥æ”¶è€…ç»„ä»¶ 2 -->
      <div class="component receiver">
        <h3>ğŸ“¥ æ¥æ”¶è€…ç»„ä»¶ B</h3>
        <p>æ¨¡æ‹Ÿå¾®å‰ç«¯ä¸­çš„ç¬¬ä¸‰ä¸ªåº”ç”¨</p>
        <div id="receiverBLog"
          class="message-log">æ¥æ”¶è€…Bæ—¥å¿—åŒºåŸŸ...</div>
        <button class="btn"
          onclick="clearReceiverBLog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>
    </div>

    <!-- å…¨å±€æ¶ˆæ¯æ—¥å¿— -->
    <div class="demo-section">
      <h3>ğŸŒ å…¨å±€æ¶ˆæ¯æ—¥å¿—</h3>
      <div id="globalLog"
        class="message-log"
        style="height: 200px;">å…¨å±€æ¶ˆæ¯ç›‘å¬å™¨æ—¥å¿—...</div>
      <button class="btn"
        onclick="clearGlobalLog()">æ¸…ç©ºå…¨å±€æ—¥å¿—</button>
    </div>

    <!-- ä»£ç ç¤ºä¾‹ -->
    <div class="demo-section">
      <h3>ğŸ’» å®ç°ä»£ç </h3>
      <div class="code-block">
        <pre>// 1. å‘é€è€…ç»„ä»¶ - å‘é€æ¶ˆæ¯
function sendMessage() {
    const message = document.getElementById('senderInput').value || 'æµ‹è¯•æ¶ˆæ¯';
    
    // åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶
    const event = new CustomEvent('micro-app-message', {
        detail: {
            from: 'sender-component',
            message: message,
            timestamp: new Date().toISOString()
        }
    });
    
    // å‘é€åˆ° window å¯¹è±¡
    window.dispatchEvent(event);
    
    // å‘é€è€…è‡ªå·±ä¹Ÿå¯ä»¥è®°å½•
    logToSender(`ğŸ“¤ å‘é€æ¶ˆæ¯: "${message}"`);
}

// 2. æ¥æ”¶è€…ç»„ä»¶ - ç›‘å¬æ¶ˆæ¯
window.addEventListener('micro-app-message', function(event) {
    const { from, message, timestamp } = event.detail;
    
    // æ‰€æœ‰ç›‘å¬å™¨éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼ŒåŒ…æ‹¬å‘é€è€…
    console.log('æ”¶åˆ°æ¶ˆæ¯:', event.detail);
    
    // æ›´æ–°å„ä¸ªç»„ä»¶çš„UI
    logToReceiverA(`ğŸ“¥ æ”¶åˆ°æ¥è‡ª ${from} çš„æ¶ˆæ¯: "${message}"`);
    logToReceiverB(`ğŸ“¥ æ”¶åˆ°æ¥è‡ª ${from} çš„æ¶ˆæ¯: "${message}"`);
    logToGlobal(`ğŸŒ å…¨å±€ç›‘å¬åˆ°æ¶ˆæ¯: "${message}" (æ¥è‡ª: ${from})`);
});

// 3. å‘é€è€…ä¹Ÿå¯ä»¥ç›‘å¬è‡ªå·±å‘é€çš„æ¶ˆæ¯
window.addEventListener('micro-app-message', function(event) {
    if (event.detail.from === 'sender-component') {
        logToSender(`âœ… ç¡®è®¤ï¼šæˆ‘å‘é€çš„æ¶ˆæ¯è¢«æˆåŠŸå¤„ç†`);
    }
});</pre>
      </div>
    </div>

    <!-- ä¸ BroadcastChannel çš„å¯¹æ¯” -->
    <div class="demo-section">
      <h3>ğŸ”„ ä¸ BroadcastChannel çš„å¯¹æ¯”</h3>
      <div class="code-block">
        <pre>// CustomEvent è¡Œä¸º
console.log('=== CustomEvent æµ‹è¯• ===');
let customEventReceived = false;

window.addEventListener('test-custom', (event) => {
    customEventReceived = true;
    console.log('âœ… CustomEvent: å‘é€è€…æ”¶åˆ°äº†è‡ªå·±çš„æ¶ˆæ¯!');
});

window.dispatchEvent(new CustomEvent('test-custom', {
    detail: { message: 'æµ‹è¯•æ¶ˆæ¯' }
}));

console.log('CustomEvent ç»“æœ:', customEventReceived); // true

// BroadcastChannel è¡Œä¸º
console.log('=== BroadcastChannel æµ‹è¯• ===');
let broadcastReceived = false;

const channel = new BroadcastChannel('test-channel');
channel.onmessage = (event) => {
    broadcastReceived = true;
    console.log('âŒ BroadcastChannel: è¿™è¡Œä»£ç ä¸ä¼šæ‰§è¡Œ');
};

channel.postMessage({ message: 'æµ‹è¯•æ¶ˆæ¯' });

setTimeout(() => {
    console.log('BroadcastChannel ç»“æœ:', broadcastReceived); // false
}, 100);</pre>
      </div>
    </div>

    <!-- å¾®å‰ç«¯å®é™…åº”ç”¨åœºæ™¯ -->
    <div class="demo-section">
      <h3>ğŸ—ï¸ å¾®å‰ç«¯å®é™…åº”ç”¨åœºæ™¯</h3>
      <div class="highlight">
        <h4>ä¸ºä»€ä¹ˆ CustomEvent é€‚åˆå¾®å‰ç«¯ï¼Ÿ</h4>
        <ul>
          <li><strong>åŒé¡µé¢é€šä¿¡</strong>ï¼šSingle-SPA ä¸­æ‰€æœ‰å¾®åº”ç”¨éƒ½åœ¨åŒä¸€ä¸ªé¡µé¢</li>
          <li><strong>å®æ—¶å“åº”</strong>ï¼šå‘é€è€…å¯ä»¥ç«‹å³çŸ¥é“æ¶ˆæ¯æ˜¯å¦è¢«å¤„ç†</li>
          <li><strong>äº‹ä»¶é©±åŠ¨</strong>ï¼šç¬¦åˆå‰ç«¯ç»„ä»¶é—´é€šä¿¡çš„æ¨¡å¼</li>
          <li><strong>ç®€å•é«˜æ•ˆ</strong>ï¼šæ— éœ€é¢å¤–çš„é€šä¿¡æœºåˆ¶</li>
        </ul>
      </div>

      <div class="code-block">
        <pre>// å¾®å‰ç«¯å®é™…ä½¿ç”¨ç¤ºä¾‹
class MicroFrontendCommunication {
    constructor(appName) {
        this.appName = appName;
        this.setupEventListeners();
    }
    
    // å‘é€ç”¨æˆ·çŠ¶æ€å˜åŒ–
    notifyUserStateChange(state) {
        window.dispatchEvent(new CustomEvent('user-state-change', {
            detail: {
                from: this.appName,
                state: state,
                timestamp: Date.now()
            }
        }));
        
        console.log(`${this.appName}: å·²é€šçŸ¥ç”¨æˆ·çŠ¶æ€å˜åŒ–`);
    }
    
    // ç›‘å¬å…¶ä»–åº”ç”¨çš„æ¶ˆæ¯
    setupEventListeners() {
        window.addEventListener('user-state-change', (event) => {
            const { from, state } = event.detail;
            
            if (from !== this.appName) {
                console.log(`${this.appName}: æ”¶åˆ°æ¥è‡ª ${from} çš„ç”¨æˆ·çŠ¶æ€å˜åŒ–`);
                this.handleUserStateChange(state);
            } else {
                console.log(`${this.appName}: ç¡®è®¤è‡ªå·±çš„æ¶ˆæ¯å·²å‘é€`);
            }
        });
    }
    
    handleUserStateChange(state) {
        // å¤„ç†ç”¨æˆ·çŠ¶æ€å˜åŒ–
        console.log(`${this.appName}: å¤„ç†ç”¨æˆ·çŠ¶æ€:`, state);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const headerApp = new MicroFrontendCommunication('header-app');
const sidebarApp = new MicroFrontendCommunication('sidebar-app');
const mainApp = new MicroFrontendCommunication('main-app');

// å½“ç”¨æˆ·ç™»å½•æ—¶
headerApp.notifyUserStateChange({ 
    action: 'login', 
    user: { id: 123, name: 'å¼ ä¸‰' } 
});

// æ‰€æœ‰åº”ç”¨ï¼ˆåŒ…æ‹¬ header-app è‡ªå·±ï¼‰éƒ½ä¼šæ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯</pre>
      </div>
    </div>
  </div>

  <script>
    // æ¶ˆæ¯è®¡æ•°å™¨
    let messageCount = 0;

    // æ—¥å¿—å‡½æ•°
    function logToSender(message) {
      const log = document.getElementById('senderLog');
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `[${timestamp}] ${message}\n`;
      log.scrollTop = log.scrollHeight;
    }

    function logToReceiverA(message) {
      const log = document.getElementById('receiverALog');
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `[${timestamp}] ${message}\n`;
      log.scrollTop = log.scrollHeight;
    }

    function logToReceiverB(message) {
      const log = document.getElementById('receiverBLog');
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `[${timestamp}] ${message}\n`;
      log.scrollTop = log.scrollHeight;
    }

    function logToGlobal(message) {
      const log = document.getElementById('globalLog');
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `[${timestamp}] ${message}\n`;
      log.scrollTop = log.scrollHeight;
    }

    // å‘é€æ¶ˆæ¯å‡½æ•°
    function sendMessage() {
      const message = document.getElementById('senderInput').value || 'æµ‹è¯•æ¶ˆæ¯';
      messageCount++;

      const event = new CustomEvent('micro-app-message', {
        detail: {
          from: 'sender-component',
          message: message,
          timestamp: new Date().toISOString(),
          id: messageCount
        }
      });

      window.dispatchEvent(event);
      logToSender(`ğŸ“¤ å‘é€æ¶ˆæ¯ #${messageCount}: "${message}"`);

      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('senderInput').value = '';
    }

    function sendUserLogin() {
      const event = new CustomEvent('user-login', {
        detail: {
          from: 'sender-component',
          user: { id: 123, name: 'å¼ ä¸‰', role: 'admin' },
          timestamp: new Date().toISOString()
        }
      });

      window.dispatchEvent(event);
      logToSender(`ğŸ“¤ å‘é€ç”¨æˆ·ç™»å½•äº‹ä»¶`);
    }

    function sendDataUpdate() {
      const event = new CustomEvent('data-update', {
        detail: {
          from: 'sender-component',
          data: { type: 'product', id: 456, action: 'update' },
          timestamp: new Date().toISOString()
        }
      });

      window.dispatchEvent(event);
      logToSender(`ğŸ“¤ å‘é€æ•°æ®æ›´æ–°äº‹ä»¶`);
    }

    // æ¸…ç©ºæ—¥å¿—å‡½æ•°
    function clearReceiverALog() {
      document.getElementById('receiverALog').innerHTML = 'æ¥æ”¶è€…Aæ—¥å¿—åŒºåŸŸ...';
    }

    function clearReceiverBLog() {
      document.getElementById('receiverBLog').innerHTML = 'æ¥æ”¶è€…Bæ—¥å¿—åŒºåŸŸ...';
    }

    function clearGlobalLog() {
      document.getElementById('globalLog').innerHTML = 'å…¨å±€æ¶ˆæ¯ç›‘å¬å™¨æ—¥å¿—...';
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    window.addEventListener('micro-app-message', function (event) {
      const { from, message, timestamp, id } = event.detail;
      logToReceiverA(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯ #${id}: "${message}" (æ¥è‡ª: ${from})`);
      logToReceiverB(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯ #${id}: "${message}" (æ¥è‡ª: ${from})`);
      logToGlobal(`ğŸŒ å…¨å±€ç›‘å¬åˆ°æ¶ˆæ¯ #${id}: "${message}" (æ¥è‡ª: ${from})`);
    });

    // å‘é€è€…ä¹Ÿç›‘å¬è‡ªå·±çš„æ¶ˆæ¯
    window.addEventListener('micro-app-message', function (event) {
      if (event.detail.from === 'sender-component') {
        logToSender(`âœ… ç¡®è®¤ï¼šæ¶ˆæ¯ #${event.detail.id} å·²è¢«æˆåŠŸå¤„ç†`);
      }
    });

    window.addEventListener('user-login', function (event) {
      const { user, from } = event.detail;
      logToReceiverA(`ğŸ‘¤ ç”¨æˆ·ç™»å½•: ${user.name} (${user.role})`);
      logToReceiverB(`ğŸ‘¤ ç”¨æˆ·ç™»å½•: ${user.name} (${user.role})`);
      logToGlobal(`ğŸ‘¤ å…¨å±€ç›‘å¬åˆ°ç”¨æˆ·ç™»å½•: ${user.name}`);

      if (from === 'sender-component') {
        logToSender(`âœ… ç¡®è®¤ï¼šç”¨æˆ·ç™»å½•äº‹ä»¶å·²å¤„ç†`);
      }
    });

    window.addEventListener('data-update', function (event) {
      const { data, from } = event.detail;
      logToReceiverA(`ğŸ“Š æ•°æ®æ›´æ–°: ${data.type} #${data.id} (${data.action})`);
      logToReceiverB(`ğŸ“Š æ•°æ®æ›´æ–°: ${data.type} #${data.id} (${data.action})`);
      logToGlobal(`ğŸ“Š å…¨å±€ç›‘å¬åˆ°æ•°æ®æ›´æ–°: ${data.type} #${data.id}`);

      if (from === 'sender-component') {
        logToSender(`âœ… ç¡®è®¤ï¼šæ•°æ®æ›´æ–°äº‹ä»¶å·²å¤„ç†`);
      }
    });

    // åˆå§‹åŒ–æ—¥å¿—
    document.addEventListener('DOMContentLoaded', function () {
      logToGlobal('ğŸš€ CustomEvent é€šä¿¡ç³»ç»Ÿå·²å¯åŠ¨');
      logToGlobal('ğŸ’¡ å‘é€æ¶ˆæ¯æµ‹è¯•åŒé¡µé¢é€šä¿¡ç‰¹æ€§');
    });
  </script>
</body>

</html>