<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
  <title>Single-SPA è·¨åŸŸé—®é¢˜ä¸é€šä¿¡æœºåˆ¶æ¼”ç¤º</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .demo-section {
      background: white;
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      overflow-x: auto;
    }

    .highlight {
      background: #fff3cd;
      padding: 15px;
      border-left: 4px solid #ffc107;
      margin: 10px 0;
    }

    .success {
      background: #d4edda;
      padding: 15px;
      border-left: 4px solid #28a745;
      margin: 10px 0;
    }

    .error {
      background: #f8d7da;
      padding: 15px;
      border-left: 4px solid #dc3545;
      margin: 10px 0;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    .btn:hover {
      background: #0056b3;
    }

    .communication-demo {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .micro-app-sim {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .micro-app-sim h4 {
      margin-top: 0;
      color: #333;
    }

    .event-log {
      background: #000;
      color: #00ff00;
      padding: 15px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸŒ Single-SPA è·¨åŸŸé—®é¢˜ä¸é€šä¿¡æœºåˆ¶æ¼”ç¤º</h1>

    <!-- è·¨åŸŸé—®é¢˜åˆ†æ -->
    <div class="demo-section">
      <h2>ğŸ” è·¨åŸŸé—®é¢˜åˆ†æ</h2>

      <h3>1. ä»€ä¹ˆæƒ…å†µä¸‹å­˜åœ¨è·¨åŸŸé—®é¢˜ï¼Ÿ</h3>
      <div class="error">
        <h4>âŒ å­˜åœ¨è·¨åŸŸé—®é¢˜çš„éƒ¨ç½²æ–¹å¼ï¼š</h4>
        <div class="code-block">
          åŸºåº§åº”ç”¨ï¼šhttps://main.example.com
          å¾®åº”ç”¨Aï¼šhttps://app-a.example.com â† ä¸åŒå­åŸŸ
          å¾®åº”ç”¨Bï¼šhttps://app-b.example.com â† ä¸åŒå­åŸŸ
          å¾®åº”ç”¨Cï¼šhttps://api.other.com â† å®Œå…¨ä¸åŒåŸŸå
        </div>
        <p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¾®åº”ç”¨ä¹‹é—´çš„ç›´æ¥é€šä¿¡ä¼šå—åˆ°åŒæºç­–ç•¥é™åˆ¶ã€‚</p>
      </div>

      <div class="success">
        <h4>âœ… ä¸å­˜åœ¨è·¨åŸŸé—®é¢˜çš„éƒ¨ç½²æ–¹å¼ï¼š</h4>
        <div class="code-block">
          åŸºåº§åº”ç”¨ï¼šhttps://example.com/
          å¾®åº”ç”¨Aï¼šhttps://example.com/app-a/ â† åŒåŸŸä¸åŒè·¯å¾„
          å¾®åº”ç”¨Bï¼šhttps://example.com/app-b/ â† åŒåŸŸä¸åŒè·¯å¾„
          å¾®åº”ç”¨Cï¼šhttps://example.com/app-c/ â† åŒåŸŸä¸åŒè·¯å¾„
        </div>
        <p>è¿™æ˜¯ Single-SPA æ¨èçš„éƒ¨ç½²æ–¹å¼ï¼Œæ‰€æœ‰åº”ç”¨éƒ½åœ¨åŒä¸€ä¸ªåŸŸä¸‹ã€‚</p>
      </div>

      <h3>2. Single-SPA çš„åŒåŸŸä¼˜åŠ¿</h3>
      <div class="highlight">
        <p><strong>Single-SPA çš„æ ¸å¿ƒä¼˜åŠ¿å°±æ˜¯è¿è¡Œæ—¶é›†æˆï¼Œæ‰€æœ‰å¾®åº”ç”¨æœ€ç»ˆéƒ½è¿è¡Œåœ¨åŒä¸€ä¸ªé¡µé¢ä¸­ï¼</strong></p>
        <ul>
          <li>æ‰€æœ‰å¾®åº”ç”¨å…±äº«åŒä¸€ä¸ª window å¯¹è±¡</li>
          <li>æ‰€æœ‰å¾®åº”ç”¨å…±äº«åŒä¸€ä¸ª document å¯¹è±¡</li>
          <li>æ‰€æœ‰å¾®åº”ç”¨åœ¨åŒä¸€ä¸ª JavaScript æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­</li>
          <li>å› æ­¤ï¼Œå¾®åº”ç”¨é—´é€šä¿¡ä¸å­˜åœ¨è·¨åŸŸé™åˆ¶</li>
        </ul>
      </div>
    </div>

    <!-- CustomEvent é€šä¿¡æ¼”ç¤º -->
    <div class="demo-section">
      <h2>ğŸ“¡ CustomEvent é€šä¿¡æœºåˆ¶æ¼”ç¤º</h2>

      <div class="communication-demo">
        <div class="micro-app-sim">
          <h4>ğŸ¯ å¾®åº”ç”¨ A (React)</h4>
          <button class="btn"
            onclick="sendFromAppA()">å‘é€æ¶ˆæ¯åˆ°åº”ç”¨B</button>
          <button class="btn"
            onclick="sendBroadcastFromA()">å¹¿æ’­æ¶ˆæ¯</button>
          <div>
            <input type="text"
              id="messageFromA"
              placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹"
              style="width: 100%; margin: 10px 0; padding: 8px;">
          </div>
          <div id="appAReceived"
            style="margin-top: 10px; min-height: 50px; background: #e3f2fd; padding: 10px; border-radius: 4px;">
            ç­‰å¾…æ¥æ”¶æ¶ˆæ¯...
          </div>
        </div>

        <div class="micro-app-sim">
          <h4>âš›ï¸ å¾®åº”ç”¨ B (Vue)</h4>
          <button class="btn"
            onclick="sendFromAppB()">å‘é€æ¶ˆæ¯åˆ°åº”ç”¨A</button>
          <button class="btn"
            onclick="sendBroadcastFromB()">å¹¿æ’­æ¶ˆæ¯</button>
          <div>
            <input type="text"
              id="messageFromB"
              placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹"
              style="width: 100%; margin: 10px 0; padding: 8px;">
          </div>
          <div id="appBReceived"
            style="margin-top: 10px; min-height: 50px; background: #e8f5e8; padding: 10px; border-radius: 4px;">
            ç­‰å¾…æ¥æ”¶æ¶ˆæ¯...
          </div>
        </div>
      </div>

      <h3>äº‹ä»¶æ—¥å¿—ï¼š</h3>
      <div id="eventLog"
        class="event-log"></div>
      <button class="btn"
        onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>

      <h3>CustomEvent å®ç°ä»£ç ï¼š</h3>
      <div class="code-block">
        <pre>// å‘é€è‡ªå®šä¹‰äº‹ä»¶
function sendMessage(eventName, data) {
    const event = new CustomEvent(eventName, {
        detail: {
            timestamp: new Date().toISOString(),
            from: 'app-a',
            to: 'app-b',
            data: data
        }
    });
    window.dispatchEvent(event);
}

// ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
window.addEventListener('micro-app-communication', (event) => {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', event.detail);
    // å¤„ç†æ¶ˆæ¯...
});

// å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åº”ç”¨
function broadcastMessage(data) {
    window.dispatchEvent(new CustomEvent('micro-app-broadcast', {
        detail: {
            timestamp: new Date().toISOString(),
            from: 'current-app',
            data: data
        }
    }));
}</pre>
      </div>
    </div>

    <!-- è·¨åŸŸè§£å†³æ–¹æ¡ˆ -->
    <div class="demo-section">
      <h2>ğŸ› ï¸ è·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>

      <h3>1. æ¨èæ–¹æ¡ˆï¼šåŒåŸŸéƒ¨ç½²</h3>
      <div class="success">
        <h4>ä½¿ç”¨åå‘ä»£ç†ï¼ˆå¦‚ Nginxï¼‰ç»Ÿä¸€åŸŸåï¼š</h4>
        <div class="code-block">
          <pre># nginx.conf
server {
    listen 80;
    server_name example.com;
    
    # åŸºåº§åº”ç”¨
    location / {
        proxy_pass http://main-app-server:3000;
    }
    
    # å¾®åº”ç”¨ A
    location /app-a/ {
        proxy_pass http://app-a-server:3001/;
    }
    
    # å¾®åº”ç”¨ B  
    location /app-b/ {
        proxy_pass http://app-b-server:3002/;
    }
}</pre>
        </div>
        <p>è¿™æ ·æ‰€æœ‰åº”ç”¨éƒ½é€šè¿‡ example.com è®¿é—®ï¼Œä¸å­˜åœ¨è·¨åŸŸé—®é¢˜ã€‚</p>
      </div>

      <h3>2. å¤‡é€‰æ–¹æ¡ˆï¼šè·¨åŸŸé€šä¿¡</h3>
      <div class="highlight">
        <p>å¦‚æœå¿…é¡»è·¨åŸŸéƒ¨ç½²ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š</p>
        <ul>
          <li><strong>PostMessage API</strong>ï¼šç”¨äº iframe é—´é€šä¿¡</li>
          <li><strong>SharedWorker</strong>ï¼šå…±äº« Worker çº¿ç¨‹é€šä¿¡</li>
          <li><strong>LocalStorage + StorageEvent</strong>ï¼šå­˜å‚¨äº‹ä»¶é€šä¿¡</li>
          <li><strong>WebSocket</strong>ï¼šé€šè¿‡æœåŠ¡å™¨ä¸­è½¬</li>
        </ul>
      </div>

      <div class="code-block">
        <pre>// PostMessage è·¨åŸŸé€šä¿¡ç¤ºä¾‹
// å‘é€æ¶ˆæ¯åˆ°å…¶ä»–åŸŸçš„åº”ç”¨
window.parent.postMessage({
    type: 'MICRO_APP_MESSAGE',
    from: 'app-a',
    to: 'app-b',
    data: 'Hello from App A'
}, 'https://app-b.example.com');

// æ¥æ”¶è·¨åŸŸæ¶ˆæ¯
window.addEventListener('message', (event) => {
    if (event.origin !== 'https://app-a.example.com') return;
    
    if (event.data.type === 'MICRO_APP_MESSAGE') {
        console.log('æ”¶åˆ°è·¨åŸŸæ¶ˆæ¯:', event.data);
    }
});</pre>
      </div>
    </div>

    <!-- æœ€ä½³å®è·µ -->
    <div class="demo-section">
      <h2>ğŸ’¡ å¾®å‰ç«¯é€šä¿¡æœ€ä½³å®è·µ</h2>

      <h3>1. é€šä¿¡æ–¹å¼é€‰æ‹©</h3>
      <div class="highlight">
        <ul>
          <li><strong>CustomEvent</strong>ï¼šé€‚ç”¨äºåŒåŸŸç¯å¢ƒï¼Œç®€å•ç›´æ¥</li>
          <li><strong>å…¨å±€çŠ¶æ€ç®¡ç†</strong>ï¼šReduxã€Vuex ç­‰çŠ¶æ€ç®¡ç†åº“</li>
          <li><strong>URL å‚æ•°</strong>ï¼šé€šè¿‡è·¯ç”±ä¼ é€’ç®€å•æ•°æ®</li>
          <li><strong>LocalStorage/SessionStorage</strong>ï¼šæŒä¹…åŒ–æ•°æ®å…±äº«</li>
        </ul>
      </div>

      <h3>2. é€šä¿¡åè®®è®¾è®¡</h3>
      <div class="code-block">
        <pre>// æ ‡å‡†åŒ–çš„æ¶ˆæ¯æ ¼å¼
const MessageProtocol = {
    // æ¶ˆæ¯ç±»å‹
    TYPES: {
        USER_LOGIN: 'USER_LOGIN',
        USER_LOGOUT: 'USER_LOGOUT',
        ROUTE_CHANGE: 'ROUTE_CHANGE',
        DATA_UPDATE: 'DATA_UPDATE'
    },
    
    // åˆ›å»ºæ¶ˆæ¯
    createMessage(type, data, from, to) {
        return {
            id: Math.random().toString(36).substr(2, 9),
            type,
            timestamp: Date.now(),
            from,
            to,
            data
        };
    },
    
    // å‘é€æ¶ˆæ¯
    send(type, data, from, to = '*') {
        const message = this.createMessage(type, data, from, to);
        window.dispatchEvent(new CustomEvent('micro-app-message', {
            detail: message
        }));
    }
};</pre>
      </div>

      <h3>3. æ³¨æ„äº‹é¡¹</h3>
      <div class="error">
        <ul>
          <li>é¿å…è¿‡åº¦é€šä¿¡ï¼Œä¿æŒå¾®åº”ç”¨çš„ç‹¬ç«‹æ€§</li>
          <li>ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ï¼Œä¾¿äºç»´æŠ¤å’Œè°ƒè¯•</li>
          <li>åšå¥½é”™è¯¯å¤„ç†å’Œå…œåº•æ–¹æ¡ˆ</li>
          <li>è€ƒè™‘æ¶ˆæ¯çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // äº‹ä»¶æ—¥å¿—
    const eventLog = document.getElementById('eventLog');

    function logEvent(message) {
      const timestamp = new Date().toLocaleTimeString();
      eventLog.innerHTML += `[${timestamp}] ${message}\n`;
      eventLog.scrollTop = eventLog.scrollHeight;
    }

    function clearLog() {
      eventLog.innerHTML = '';
    }

    // å¾®åº”ç”¨ A çš„é€šä¿¡é€»è¾‘
    function sendFromAppA() {
      const message = document.getElementById('messageFromA').value || 'æ¥è‡ªåº”ç”¨Açš„æ¶ˆæ¯';
      const event = new CustomEvent('app-b-message', {
        detail: {
          from: 'app-a',
          to: 'app-b',
          message: message,
          timestamp: new Date().toISOString()
        }
      });
      window.dispatchEvent(event);
      logEvent(`ğŸ“¤ åº”ç”¨Aå‘é€æ¶ˆæ¯ç»™åº”ç”¨B: "${message}"`);
    }

    function sendBroadcastFromA() {
      const message = document.getElementById('messageFromA').value || 'æ¥è‡ªåº”ç”¨Açš„å¹¿æ’­æ¶ˆæ¯';
      const event = new CustomEvent('micro-app-broadcast', {
        detail: {
          from: 'app-a',
          message: message,
          timestamp: new Date().toISOString()
        }
      });
      window.dispatchEvent(event);
      logEvent(`ğŸ“¢ åº”ç”¨Aå¹¿æ’­æ¶ˆæ¯: "${message}"`);
    }

    // å¾®åº”ç”¨ B çš„é€šä¿¡é€»è¾‘
    function sendFromAppB() {
      const message = document.getElementById('messageFromB').value || 'æ¥è‡ªåº”ç”¨Bçš„æ¶ˆæ¯';
      const event = new CustomEvent('app-a-message', {
        detail: {
          from: 'app-b',
          to: 'app-a',
          message: message,
          timestamp: new Date().toISOString()
        }
      });
      window.dispatchEvent(event);
      logEvent(`ğŸ“¤ åº”ç”¨Bå‘é€æ¶ˆæ¯ç»™åº”ç”¨A: "${message}"`);
    }

    function sendBroadcastFromB() {
      const message = document.getElementById('messageFromB').value || 'æ¥è‡ªåº”ç”¨Bçš„å¹¿æ’­æ¶ˆæ¯';
      const event = new CustomEvent('micro-app-broadcast', {
        detail: {
          from: 'app-b',
          message: message,
          timestamp: new Date().toISOString()
        }
      });
      window.dispatchEvent(event);
      logEvent(`ğŸ“¢ åº”ç”¨Bå¹¿æ’­æ¶ˆæ¯: "${message}"`);
    }

    // åº”ç”¨Aç›‘å¬æ¥è‡ªåº”ç”¨Bçš„æ¶ˆæ¯
    window.addEventListener('app-a-message', (event) => {
      const { from, message, timestamp } = event.detail;
      document.getElementById('appAReceived').innerHTML =
        `<strong>æ”¶åˆ°æ¥è‡ª${from}çš„æ¶ˆæ¯ï¼š</strong><br>${message}<br><small>æ—¶é—´ï¼š${timestamp}</small>`;
      logEvent(`ğŸ“¥ åº”ç”¨Aæ”¶åˆ°æ¶ˆæ¯: "${message}"`);
    });

    // åº”ç”¨Bç›‘å¬æ¥è‡ªåº”ç”¨Açš„æ¶ˆæ¯
    window.addEventListener('app-b-message', (event) => {
      const { from, message, timestamp } = event.detail;
      document.getElementById('appBReceived').innerHTML =
        `<strong>æ”¶åˆ°æ¥è‡ª${from}çš„æ¶ˆæ¯ï¼š</strong><br>${message}<br><small>æ—¶é—´ï¼š${timestamp}</small>`;
      logEvent(`ğŸ“¥ åº”ç”¨Bæ”¶åˆ°æ¶ˆæ¯: "${message}"`);
    });

    // ç›‘å¬å¹¿æ’­æ¶ˆæ¯
    window.addEventListener('micro-app-broadcast', (event) => {
      const { from, message, timestamp } = event.detail;
      logEvent(`ğŸ“» æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ (æ¥è‡ª${from}): "${message}"`);

      // æ›´æ–°ä¸¤ä¸ªåº”ç”¨çš„æ¥æ”¶åŒºåŸŸ
      const broadcastInfo = `<strong>ğŸ“¢ å¹¿æ’­æ¶ˆæ¯ (æ¥è‡ª${from})ï¼š</strong><br>${message}<br><small>æ—¶é—´ï¼š${timestamp}</small>`;
      if (from !== 'app-a') {
        document.getElementById('appAReceived').innerHTML = broadcastInfo;
      }
      if (from !== 'app-b') {
        document.getElementById('appBReceived').innerHTML = broadcastInfo;
      }
    });

    // åˆå§‹åŒ–æ—¥å¿—
    logEvent('ğŸš€ å¾®å‰ç«¯é€šä¿¡æ¼”ç¤ºç³»ç»Ÿå¯åŠ¨');
    logEvent('âœ… CustomEvent ç›‘å¬å™¨å·²è®¾ç½®');
    logEvent('ğŸ’¡ æç¤ºï¼šåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ¶ˆæ¯ï¼Œç„¶åç‚¹å‡»æŒ‰é’®æµ‹è¯•é€šä¿¡');
  </script>
</body>

</html>